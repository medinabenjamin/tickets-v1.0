{% extends 'soporte/base.html' %}
{% block title %}{{ modo|capfirst }} FAQ{% endblock %}

{% block content %}
<h2 class="page-title">{% if modo == 'editar' %}Editar Pregunta Frecuente{% else %}Nueva Pregunta Frecuente{% endif %}</h2>

<div class="card-custom">
  <div class="card-custom-header">
    <i class="fas fa-pen-to-square"></i> Datos de la pregunta
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="row g-3">
      <div class="col-12">
        <label class="form-label">Título de la pregunta</label>
        {{ form.pregunta.errors }}
        {{ form.pregunta }}
      </div>
    </div>

    <div id="respuestaFieldWrapper"
         class="mb-3 d-none"
         data-label-rapida="Respuesta"
         data-label-pasos="Descripción general (opcional)"
         data-help-rapida="Incluye la respuesta directa a la pregunta."
         data-help-pasos="Resume el contexto antes de los pasos, si aplica.">
      <label id="respuestaFieldLabel" class="form-label"></label>
      {{ form.respuesta.errors }}
      {{ form.respuesta }}
      <div id="respuestaFieldHelp" class="form-text text-muted"></div>
    </div>

    <div class="card-custom mt-3">
      <div class="card-custom-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-layer-group"></i> Tipo de contenido</span>
        <small class="text-muted">Elige cómo quieres responder la pregunta</small>
      </div>
      <div class="p-3">
        <div class="btn-group" role="group" aria-label="Tipo de FAQ" id="faqTypeSelector" data-default-type="{% if faq_tiene_pasos %}pasos{% else %}rapida{% endif %}">
          <button type="button" class="btn btn-outline-primary" data-faq-type="rapida">
            <i class="fas fa-message"></i> Respuesta breve
          </button>
          <button type="button" class="btn btn-outline-primary" data-faq-type="pasos">
            <i class="fas fa-route"></i> Guía paso a paso
          </button>
        </div>
      </div>
    </div>

    <div id="faqQuickAnswer" class="card-custom mt-3" data-section="rapida">
      <div class="card-custom-header">
        <i class="fas fa-message"></i> Respuesta breve
      </div>
      <div class="p-3">
        <div class="text-muted small mb-3">Usa esta opción para preguntas con respuesta directa.</div>
        <div data-response-slot="rapida"></div>
      </div>
    </div>

    <div id="faqStepByStep" class="card-custom mt-3" data-section="pasos">
      <div class="card-custom-header">
        <i class="fas fa-list-ol"></i> Guía paso a paso
      </div>
      <div class="p-3">
        <div class="text-muted small mb-3">Descompón la respuesta en pasos claros e incorpora imágenes cuando sea necesario.</div>
        <div class="mb-3" data-response-slot="pasos"></div>

        {{ formset.management_form }}
        {{ formset.non_form_errors }}
        <div id="pasosContainer">
          {% for f in formset %}
            <div class="faq-step card border-0 p-0 mb-3" data-step-index="{{ forloop.counter0 }}">
              {{ f.orden }}
              <div class="d-flex align-items-center mb-2 gap-2">
                <span class="faq-step-badge">Paso {{ forloop.counter }}</span>
                <div class="flex-grow-1">
                  <label class="form-label mb-1">Título del paso</label>
                  {{ f.titulo.errors }}
                  {{ f.titulo }}
                </div>
                {% if f.instance.pk %}
                  <div class="form-check ms-2">
                    {{ f.DELETE }} <label class="form-check-label small">Eliminar</label>
                  </div>
                {% endif %}
              </div>

              <div class="mb-2">
                <label class="form-label">Descripción</label>
                {{ f.descripcion.errors }}
                {{ f.descripcion }}
              </div>

              <div class="mb-2">
                <label class="form-label">Adjuntar imagen (opcional)</label>
                {{ f.adjunto.errors }}
                {{ f.adjunto }}
                {% if f.instance.pk and f.instance.adjunto %}
                  <div class="mt-2">
                    <img src="{{ f.instance.adjunto.url }}" class="faq-step-thumb img-thumbnail"
                         alt="Adjunto del paso"
                         data-enlarge-src="{{ f.instance.adjunto.url }}">
                  </div>
                {% endif %}
              </div>
              <hr>
            </div>
          {% endfor %}
        </div>

        <template id="emptyStepTemplate">
          <div class="faq-step card border-0 p-0 mb-3" data-step-index="__prefix__">
            {{ formset.empty_form.orden }}
            <div class="d-flex align-items-center mb-2 gap-2">
              <span class="faq-step-badge">Paso X</span>
              <div class="flex-grow-1">
                <label class="form-label mb-1">Título del paso</label>
                {{ formset.empty_form.titulo }}
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Descripción</label>
              {{ formset.empty_form.descripcion }}
            </div>
            <div class="mb-2">
              <label class="form-label">Adjuntar imagen (opcional)</label>
              {{ formset.empty_form.adjunto }}
            </div>
            <hr>
          </div>
        </template>

        <div class="d-flex gap-2 justify-content-end">
          <button type="button" class="btn btn-outline-danger btn-sm" id="removeStepBtn" disabled>Eliminar paso</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="addStepBtn">Agregar paso</button>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'lista_faqs' %}" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success">Guardar</button>
    </div>
  </form>
</div>

<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <img id="imgModalContent" alt="Vista ampliada" />
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const container   = document.getElementById('pasosContainer');
  const addBtn      = document.getElementById('addStepBtn');
  const removeBtn   = document.getElementById('removeStepBtn');
  const tmpl        = document.getElementById('emptyStepTemplate');
  const totalInput  = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');
  const typeSelector = document.getElementById('faqTypeSelector');
  const sections = document.querySelectorAll('[data-section]');
  const responseWrapper = document.getElementById('respuestaFieldWrapper');
  const responseLabel = document.getElementById('respuestaFieldLabel');
  const responseHelp = document.getElementById('respuestaFieldHelp');

  function getVisibleSteps() {
    return Array.from(container.querySelectorAll('.faq-step')).filter(step => !step.classList.contains('d-none'));
  }

  function updateRemoveState() {
    if (!removeBtn) return;
    const stepsVisible = getVisibleSteps().length;
    removeBtn.disabled = stepsVisible <= 1 || document.getElementById('faqStepByStep')?.classList.contains('d-none');
  }

  function renumerar() {
    const steps = getVisibleSteps();
    steps.forEach((node, i) => {
      const badge = node.querySelector('.faq-step-badge');
      if (badge) badge.textContent = 'Paso ' + (i + 1);
      const ordenInput = node.querySelector('input[name$="-orden"]');
      if (ordenInput) ordenInput.value = (i + 1);
    });
    updateRemoveState();
  }

  function wirePreview(scope) {
    scope.querySelectorAll('img.faq-step-thumb').forEach(img => {
      img.onclick = () => {
        const src = img.getAttribute('data-enlarge-src') || img.src;
        const modalImg = document.getElementById('imgModalContent');
        modalImg.src = src;
        new bootstrap.Modal(document.getElementById('imgModal')).show();
      };
    });

    scope.querySelectorAll('input[type="file"]').forEach(input => {
      input.onchange = () => {
        const f = input.files && input.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        let thumb = input.closest('.mb-2')?.querySelector('img.faq-step-thumb');
        if (!thumb) {
          thumb = document.createElement('img');
          thumb.className = 'faq-step-thumb img-thumbnail mt-2';
          input.closest('.mb-2').appendChild(thumb);
        }
        const url = URL.createObjectURL(f);
        thumb.src = url;
        thumb.setAttribute('data-enlarge-src', url);
        thumb.onclick = () => {
          const modalImg = document.getElementById('imgModalContent');
          modalImg.src = url;
          new bootstrap.Modal(document.getElementById('imgModal')).show();
        };
      };
    });
  }

  function capitalize(text) {
    return text ? text.charAt(0).toUpperCase() + text.slice(1) : '';
  }

  function placeResponseField(type) {
    if (!responseWrapper) return;
    const slot = document.querySelector(`[data-response-slot="${type}"]`);
    if (!slot) return;
    slot.appendChild(responseWrapper);
    responseWrapper.classList.remove('d-none');

    const labelKey = `label${capitalize(type)}`;
    const helpKey = `help${capitalize(type)}`;
    if (responseLabel && responseWrapper.dataset[labelKey]) {
      responseLabel.textContent = responseWrapper.dataset[labelKey];
    }
    if (responseHelp) {
      responseHelp.textContent = responseWrapper.dataset[helpKey] || '';
    }
  }

  function setType(type) {
    sections.forEach(section => {
      section.classList.toggle('d-none', section.dataset.section !== type);
    });

    document.querySelectorAll('[data-faq-type]').forEach(btn => {
      const isActive = btn.dataset.faqType === type;
      btn.classList.toggle('active', isActive);
      btn.classList.toggle('btn-primary', isActive);
      btn.classList.toggle('btn-outline-primary', !isActive);
    });

    placeResponseField(type);
    updateRemoveState();
  }

  wirePreview(document);

  addBtn?.addEventListener('click', () => {
    const idx = parseInt(totalInput.value, 10);
    const wrapper = document.createElement('div');
    wrapper.innerHTML = tmpl.innerHTML.replace(/__prefix__/g, idx).trim();
    const node = wrapper.firstElementChild;
    container.appendChild(node);
    totalInput.value = idx + 1;
    renumerar();
    wirePreview(node);
    updateRemoveState();
  });

  removeBtn?.addEventListener('click', () => {
    const steps = getVisibleSteps();
    if (steps.length <= 1) return;
    const last = steps[steps.length - 1];
    const deleteCheckbox = last.querySelector('input[type="checkbox"][name$="-DELETE"]');

    if (deleteCheckbox) {
      deleteCheckbox.checked = true;
      last.classList.add('d-none');
      last.setAttribute('aria-hidden', 'true');
    } else {
      last.remove();
      const currentTotal = Math.max(0, parseInt(totalInput.value, 10) - 1);
      totalInput.value = currentTotal;
    }

    renumerar();
  });

  const defaultType = typeSelector?.dataset.defaultType || 'rapida';
  setType(defaultType);
  renumerar();
  updateRemoveState();

  typeSelector?.addEventListener('click', event => {
    const target = event.target.closest('[data-faq-type]');
    if (!target) return;
    setType(target.dataset.faqType);
  });
</script>
{% endblock %}
