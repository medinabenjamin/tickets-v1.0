{% extends 'soporte/base.html' %}
{% block title %}{{ modo|capfirst }} FAQ{% endblock %}

{% block content %}
<h2 class="page-title">{% if modo == 'editar' %}Editar Pregunta Frecuente{% else %}Nueva Pregunta Frecuente{% endif %}</h2>

<div class="card-custom">
  <div class="card-custom-header">
    <i class="fas fa-pen-to-square"></i> Datos de la pregunta
  </div>

  <form method="post" enctype="multipart/form-data" id="faqForm">
    {% csrf_token %}

    <div class="mb-3">
      <label class="form-label">Título de la pregunta</label>
      {{ form.pregunta }}
    </div>

    <div class="card-custom mt-3">
      <div class="card-custom-header">
        <i class="fas fa-list-ol"></i> Pasos para solucionarlo (opcional)
      </div>

      {{ formset.management_form }}
      <div id="pasosContainer">
        {% for f in formset %}
          <div class="faq-step card border-0 p-0 mb-3" data-step-index="{{ forloop.counter0 }}">
            {{ f.orden }} {# hidden #}

            <div class="d-flex align-items-center mb-2 gap-2">
              <span class="faq-step-badge">Paso {{ forloop.counter }}</span>
              <div class="flex-grow-1">
                <label class="form-label mb-1">Título del paso</label>
                {{ f.titulo }}
              </div>
              {% if f.instance.pk %}
                <div class="form-check ms-2">
                  {{ f.DELETE }} <label class="form-check-label small">Eliminar</label>
                </div>
              {% endif %}
            </div>

            <div class="mb-2">
              <label class="form-label">Descripción</label>
              {{ f.descripcion }}
            </div>

            <div class="mb-2">
              <label class="form-label">Adjuntar imagen (opcional)</label>
              {{ f.adjunto }}
              {% if f.instance.pk and f.instance.adjunto %}
                <div class="mt-2">
                  <img src="{{ f.instance.adjunto.url }}" class="faq-step-thumb img-thumbnail"
                       alt="Adjunto del paso"
                       data-enlarge-src="{{ f.instance.adjunto.url }}">
                </div>
              {% endif %}
            </div>
            <hr>
          </div>
        {% endfor %}
      </div>

      {# plantilla para clonar un nuevo paso #}
      <template id="emptyStepTemplate">
        <div class="faq-step card border-0 p-0 mb-3" data-step-index="__prefix__">
          {{ formset.empty_form.orden }}
          <div class="d-flex align-items-center mb-2 gap-2">
            <span class="faq-step-badge">Paso X</span>
            <div class="flex-grow-1">
              <label class="form-label mb-1">Título del paso</label>
              {{ formset.empty_form.titulo }}
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            {{ formset.empty_form.descripcion }}
          </div>
          <div class="mb-2">
            <label class="form-label">Adjuntar imagen (opcional)</label>
            {{ formset.empty_form.adjunto }}
          </div>
          <hr>
        </div>
      </template>

      <div class="d-flex">
        <button type="button" class="btn btn-outline-secondary btn-sm ms-auto" id="addStepBtn">
          Agregar paso
        </button>
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <a href="{% url 'lista_faqs' %}" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success">Guardar</button>
    </div>
  </form>
</div>

{# Modal para ampliar imagen #}
<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <img id="imgModalContent" alt="Vista ampliada" />
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const container   = document.getElementById('pasosContainer');
  const addBtn      = document.getElementById('addStepBtn');
  const tmpl        = document.getElementById('emptyStepTemplate');
  const totalInput  = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');

  function renumerar() {
    const steps = container.querySelectorAll('.faq-step');
    steps.forEach((node, i) => {
      const badge = node.querySelector('.faq-step-badge');
      if (badge) badge.textContent = 'Paso ' + (i + 1);
      const ordenInput = node.querySelector('input[name$="-orden"]');
      if (ordenInput) ordenInput.value = (i + 1);
    });
  }

  function wirePreview(scope) {
    // thumbnail existente -> modal
    scope.querySelectorAll('img.faq-step-thumb').forEach(img => {
      img.onclick = () => {
        const src = img.getAttribute('data-enlarge-src') || img.src;
        const modalImg = document.getElementById('imgModalContent');
        modalImg.src = src;
        new bootstrap.Modal(document.getElementById('imgModal')).show();
      };
    });
    // input file -> UNA miniatura, tamaño controlado por CSS
    scope.querySelectorAll('input[type="file"]').forEach(input => {
      input.onchange = e => {
        const f = input.files && input.files[0];
        if (!f || !f.type.startsWith('image/')) return;
        let thumb = input.closest('.mb-2').querySelector('img.faq-step-thumb');
        if (!thumb) {
          thumb = document.createElement('img');
          thumb.className = 'faq-step-thumb img-thumbnail mt-2';
          input.closest('.mb-2').appendChild(thumb);
        }
        const url = URL.createObjectURL(f);
        thumb.src = url;
        thumb.setAttribute('data-enlarge-src', url);
        thumb.onclick = () => {
          const modalImg = document.getElementById('imgModalContent');
          modalImg.src = url;
          new bootstrap.Modal(document.getElementById('imgModal')).show();
        };
      };
    });
  }

  // Inicial
  wirePreview(document);
  addBtn?.addEventListener('click', () => {
    const idx = parseInt(totalInput.value, 10);
    const wrapper = document.createElement('div');
    wrapper.innerHTML = tmpl.innerHTML.replace(/__prefix__/g, idx).trim();
    const node = wrapper.firstElementChild;
    container.appendChild(node);
    totalInput.value = idx + 1;
    renumerar();
    wirePreview(node);
  });
  renumerar();
</script>
{% endblock %}
