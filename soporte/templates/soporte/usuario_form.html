{% extends 'soporte/base.html' %}
{% load widget_tweaks static %}

{% block title %}{% if is_edit %}Editar usuario{% else %}Crear usuario{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex align-items-center mb-2">
        <div>
            <h2 class="page-title mb-0">{% if is_edit %}Editar usuario{% else %}Crear usuario{% endif %}</h2>
            <p class="page-subtitle">Administra los usuarios del sistema</p>
        </div>
    </div>

    <div class="card-custom">
        <div class="card-custom-header d-flex justify-content-between align-items-center">
            <div><i class="fas fa-user me-2"></i>{% if is_edit %}Actualizar datos{% else %}Nuevo usuario{% endif %}</div>
            <a href="{% url 'mantenedor_usuarios' %}" class="btn btn-outline-secondary btn-sm">Volver al listado</a>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.username.id_for_label }}">Usuario</label>
                        {% render_field form.username class="form-control" %}
                        {% for error in form.username.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.email.id_for_label }}">Correo</label>
                        {% render_field form.email class="form-control" %}
                        {% for error in form.email.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.first_name.id_for_label }}">Nombre</label>
                        {% render_field form.first_name class="form-control" %}
                        {% for error in form.first_name.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.last_name.id_for_label }}">Apellido</label>
                        {% render_field form.last_name class="form-control" %}
                        {% for error in form.last_name.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.rut.id_for_label }}">RUT</label>
                        {% render_field form.rut class="form-control" placeholder="12345678-5" %}
                        {% if form.rut.help_text %}<div class="form-text">{{ form.rut.help_text }}</div>{% endif %}
                        {% for error in form.rut.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <hr class="my-4" />
                <p class="fw-semibold mb-3">Seguridad</p>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.password.id_for_label }}">{{ form.password.label }}</label>
                        {% render_field form.password class="form-control" %}
                        {% if form.password.help_text %}<div class="form-text">{{ form.password.help_text }}</div>{% endif %}
                        {% for error in form.password.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label" for="{{ form.password_confirm.id_for_label }}">{{ form.password_confirm.label }}</label>
                        {% render_field form.password_confirm class="form-control" %}
                        {% for error in form.password_confirm.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <hr class="my-4" />
                <p class="fw-semibold mb-3">Roles y estado</p>
                <div class="row g-3">
                    <div class="col-12 col-md-8">
                        <label class="form-label" for="{{ form.groups.id_for_label }}">Roles asignados</label>
                        {% render_field form.groups class="form-select" %}
                        {% if form.groups.help_text %}<div class="form-text">{{ form.groups.help_text }}</div>{% endif %}
                        {% for error in form.groups.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12 col-md-2 d-flex align-items-end">
                        <div class="form-check form-switch">
                            {% render_field form.is_active class="form-check-input" %}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Activo</label>
                        </div>
                    </div>
                    <div class="col-12 col-md-2 d-flex align-items-end">
                        <div class="form-check form-switch">
                            {% render_field form.es_critico class="form-check-input" %}
                            <label class="form-check-label" for="{{ form.es_critico.id_for_label }}">Usuario cr√≠tico</label>
                            {% if form.es_critico.help_text %}<div class="form-text">{{ form.es_critico.help_text }}</div>{% endif %}
                            {% for error in form.es_critico.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'mantenedor_usuarios' %}" class="btn btn-outline-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-dark">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
